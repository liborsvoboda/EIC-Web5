{"version":3,"file":"wsServer.js","names":["_utils","require","_utilsBundle","_debugLogger","lastConnectionId","kConnectionSymbol","Symbol","perMessageDeflate","exports","zlibDeflateOptions","level","zlibInflateOptions","chunkSize","threshold","WSServer","constructor","delegate","_wsServer","server","_delegate","listen","port","hostname","path","debugLogger","log","Date","createHttpServer","request","response","method","url","setHeader","end","JSON","stringify","wsEndpointPath","on","error","String","wsEndpoint","Promise","resolve","reject","address","Error","wsServer","noServer","onHeaders","headers","socket","head","_this$_delegate$onUpg","_this$_delegate","_this$_wsServer","pathname","URL","write","httpVersion","destroy","upgradeResult","onUpgrade","call","handleUpgrade","ws","_this$_wsServer2","emit","extensions","id","connection","onConnection","close","_this$_delegate$onClo","_this$_delegate2","waitForClose","f","all","Array","from","clients","map","terminate","e","undefined","onClose"],"sources":["../../src/utils/wsServer.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type http from 'http';\nimport type stream from 'stream';\nimport { createHttpServer } from '../utils';\nimport type { WebSocketServer, WebSocket } from '../utilsBundle';\nimport { wsServer } from '../utilsBundle';\nimport { debugLogger } from './debugLogger';\n\nlet lastConnectionId = 0;\nconst kConnectionSymbol = Symbol('kConnection');\n\nexport const perMessageDeflate = {\n  zlibDeflateOptions: {\n    level: 3,\n  },\n  zlibInflateOptions: {\n    chunkSize: 10 * 1024\n  },\n  threshold: 10 * 1024,\n};\n\nexport type WSConnection = {\n  close: () => Promise<void>;\n};\n\nexport type WSServerDelegate = {\n  onHeaders?: (headers: string[]) => void;\n  onUpgrade?: (request: http.IncomingMessage, socket: stream.Duplex) => { error: string } | undefined;\n  onConnection: (request: http.IncomingMessage, url: URL, ws: WebSocket, id: string) => WSConnection;\n  onClose?(): Promise<void>;\n};\n\nexport class WSServer {\n  private _wsServer: WebSocketServer | undefined;\n  server: http.Server | undefined;\n  private _delegate: WSServerDelegate;\n\n  constructor(delegate: WSServerDelegate) {\n    this._delegate = delegate;\n  }\n\n  async listen(port: number = 0, hostname: string | undefined, path: string): Promise<string> {\n    debugLogger.log('server', `Server started at ${new Date()}`);\n\n    const server = createHttpServer((request: http.IncomingMessage, response: http.ServerResponse) => {\n      if (request.method === 'GET' && request.url === '/json') {\n        response.setHeader('Content-Type', 'application/json');\n        response.end(JSON.stringify({\n          wsEndpointPath: path,\n        }));\n        return;\n      }\n      response.end('Running');\n    });\n    server.on('error', error => debugLogger.log('server', String(error)));\n    this.server = server;\n\n    const wsEndpoint = await new Promise<string>((resolve, reject) => {\n      server.listen(port, hostname, () => {\n        const address = server.address();\n        if (!address) {\n          reject(new Error('Could not bind server socket'));\n          return;\n        }\n        const wsEndpoint = typeof address === 'string' ? `${address}${path}` : `ws://${hostname || 'localhost'}:${address.port}${path}`;\n        resolve(wsEndpoint);\n      }).on('error', reject);\n    });\n\n    debugLogger.log('server', 'Listening at ' + wsEndpoint);\n\n    this._wsServer = new wsServer({\n      noServer: true,\n      perMessageDeflate,\n    });\n\n    if (this._delegate.onHeaders)\n      this._wsServer.on('headers', headers => this._delegate.onHeaders!(headers));\n\n    server.on('upgrade', (request, socket, head) => {\n      const pathname = new URL('http://localhost' + request.url!).pathname;\n      if (pathname !== path) {\n        socket.write(`HTTP/${request.httpVersion} 400 Bad Request\\r\\n\\r\\n`);\n        socket.destroy();\n        return;\n      }\n      const upgradeResult = this._delegate.onUpgrade?.(request, socket);\n      if (upgradeResult) {\n        socket.write(upgradeResult.error);\n        socket.destroy();\n        return;\n      }\n      this._wsServer?.handleUpgrade(request, socket, head, ws => this._wsServer?.emit('connection', ws, request));\n    });\n\n    this._wsServer.on('connection', (ws, request) => {\n      debugLogger.log('server', 'Connected client ws.extension=' + ws.extensions);\n      const url = new URL('http://localhost' + (request.url || ''));\n      const id = String(++lastConnectionId);\n      debugLogger.log('server', `[${id}] serving connection: ${request.url}`);\n      const connection = this._delegate.onConnection(request, url, ws, id);\n      (ws as any)[kConnectionSymbol] = connection;\n    });\n\n    return wsEndpoint;\n  }\n\n  async close() {\n    const server = this._wsServer;\n    if (!server)\n      return;\n    debugLogger.log('server', 'closing websocket server');\n    const waitForClose = new Promise(f => server.close(f));\n    // First disconnect all remaining clients.\n    await Promise.all(Array.from(server.clients).map(async ws => {\n      const connection = (ws as any)[kConnectionSymbol] as WSConnection | undefined;\n      if (connection)\n        await connection.close();\n      try {\n        ws.terminate();\n      } catch (e) {\n      }\n    }));\n    await waitForClose;\n    debugLogger.log('server', 'closing http server');\n    if (this.server)\n      await new Promise(f => this.server!.close(f));\n    this._wsServer = undefined;\n    this.server = undefined;\n    debugLogger.log('server', 'closed server');\n\n    await this._delegate.onClose?.();\n  }\n}\n"],"mappings":"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","ignoreList":[]}
{"version":3,"file":"timeoutRunner.js","names":["_","require","raceAgainstDeadline","cb","deadline","timer","Promise","race","then","result","timedOut","resolve","kMaxDeadline","timeout","monotonicTime","setTimeout","finally","clearTimeout","pollAgainstDeadline","callback","pollIntervals","_pollIntervals$pop","lastPollInterval","pop","lastResult","wrappedCallback","_shift","time","received","continuePolling","interval","shift","x"],"sources":["../../src/utils/timeoutRunner.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { monotonicTime } from './';\n\nexport async function raceAgainstDeadline<T>(cb: () => Promise<T>, deadline: number): Promise<{ result: T, timedOut: false } | { timedOut: true }> {\n  let timer: NodeJS.Timeout | undefined;\n  return Promise.race([\n    cb().then(result => {\n      return { result, timedOut: false };\n    }),\n    new Promise<{ timedOut: true }>(resolve => {\n      const kMaxDeadline = 2147483647; // 2^31-1\n      const timeout = (deadline || kMaxDeadline) - monotonicTime();\n      timer = setTimeout(() => resolve({ timedOut: true }), timeout);\n    }),\n  ]).finally(() => {\n    clearTimeout(timer);\n  });\n}\n\nexport async function pollAgainstDeadline<T>(callback: () => Promise<{ continuePolling: boolean, result: T }>, deadline: number, pollIntervals: number[] = [100, 250, 500, 1000]): Promise<{ result?: T, timedOut: boolean }> {\n  const lastPollInterval = pollIntervals.pop() ?? 1000;\n  let lastResult: T|undefined;\n  const wrappedCallback = () => Promise.resolve().then(callback);\n  while (true) {\n    const time = monotonicTime();\n    if (deadline && time >= deadline)\n      break;\n    const received = await raceAgainstDeadline(wrappedCallback, deadline);\n    if (received.timedOut)\n      break;\n    lastResult = (received as any).result.result;\n    if (!(received as any).result.continuePolling)\n      return { result: lastResult, timedOut: false };\n    const interval = pollIntervals!.shift() ?? lastPollInterval;\n    if (deadline && deadline <= monotonicTime() + interval)\n      break;\n    await new Promise(x => setTimeout(x, interval));\n  }\n  return { timedOut: true, result: lastResult };\n}\n"],"mappings":";;;;;;;AAgBA,IAAAA,CAAA,GAAAC,OAAA;AAhBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAIO,eAAeC,mBAAmBA,CAAIC,EAAoB,EAAEC,QAAgB,EAAgE;EACjJ,IAAIC,KAAiC;EACrC,OAAOC,OAAO,CAACC,IAAI,CAAC,CAClBJ,EAAE,CAAC,CAAC,CAACK,IAAI,CAACC,MAAM,IAAI;IAClB,OAAO;MAAEA,MAAM;MAAEC,QAAQ,EAAE;IAAM,CAAC;EACpC,CAAC,CAAC,EACF,IAAIJ,OAAO,CAAqBK,OAAO,IAAI;IACzC,MAAMC,YAAY,GAAG,UAAU,CAAC,CAAC;IACjC,MAAMC,OAAO,GAAG,CAACT,QAAQ,IAAIQ,YAAY,IAAI,IAAAE,eAAa,EAAC,CAAC;IAC5DT,KAAK,GAAGU,UAAU,CAAC,MAAMJ,OAAO,CAAC;MAAED,QAAQ,EAAE;IAAK,CAAC,CAAC,EAAEG,OAAO,CAAC;EAChE,CAAC,CAAC,CACH,CAAC,CAACG,OAAO,CAAC,MAAM;IACfC,YAAY,CAACZ,KAAK,CAAC;EACrB,CAAC,CAAC;AACJ;AAEO,eAAea,mBAAmBA,CAAIC,QAAgE,EAAEf,QAAgB,EAAEgB,aAAuB,GAAG,CAAC,GAAG,EAAE,GAAG,EAAE,GAAG,EAAE,IAAI,CAAC,EAA8C;EAAA,IAAAC,kBAAA;EAC5N,MAAMC,gBAAgB,IAAAD,kBAAA,GAAGD,aAAa,CAACG,GAAG,CAAC,CAAC,cAAAF,kBAAA,cAAAA,kBAAA,GAAI,IAAI;EACpD,IAAIG,UAAuB;EAC3B,MAAMC,eAAe,GAAGA,CAAA,KAAMnB,OAAO,CAACK,OAAO,CAAC,CAAC,CAACH,IAAI,CAACW,QAAQ,CAAC;EAC9D,OAAO,IAAI,EAAE;IAAA,IAAAO,MAAA;IACX,MAAMC,IAAI,GAAG,IAAAb,eAAa,EAAC,CAAC;IAC5B,IAAIV,QAAQ,IAAIuB,IAAI,IAAIvB,QAAQ,EAC9B;IACF,MAAMwB,QAAQ,GAAG,MAAM1B,mBAAmB,CAACuB,eAAe,EAAErB,QAAQ,CAAC;IACrE,IAAIwB,QAAQ,CAAClB,QAAQ,EACnB;IACFc,UAAU,GAAII,QAAQ,CAASnB,MAAM,CAACA,MAAM;IAC5C,IAAI,CAAEmB,QAAQ,CAASnB,MAAM,CAACoB,eAAe,EAC3C,OAAO;MAAEpB,MAAM,EAAEe,UAAU;MAAEd,QAAQ,EAAE;IAAM,CAAC;IAChD,MAAMoB,QAAQ,IAAAJ,MAAA,GAAGN,aAAa,CAAEW,KAAK,CAAC,CAAC,cAAAL,MAAA,cAAAA,MAAA,GAAIJ,gBAAgB;IAC3D,IAAIlB,QAAQ,IAAIA,QAAQ,IAAI,IAAAU,eAAa,EAAC,CAAC,GAAGgB,QAAQ,EACpD;IACF,MAAM,IAAIxB,OAAO,CAAC0B,CAAC,IAAIjB,UAAU,CAACiB,CAAC,EAAEF,QAAQ,CAAC,CAAC;EACjD;EACA,OAAO;IAAEpB,QAAQ,EAAE,IAAI;IAAED,MAAM,EAAEe;EAAW,CAAC;AAC/C","ignoreList":[]}
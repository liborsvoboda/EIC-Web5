{"version":3,"file":"manualPromise.js","names":["_stackTrace","require","ManualPromise","Promise","constructor","resolve","reject","f","r","_resolve","_reject","_isDone","isDone","t","e","Symbol","species","toStringTag","exports","LongStandingScope","_terminateError","_closeError","_terminatePromises","Map","_isClosed","error","p","keys","close","frames","cloneError","isClosed","raceMultiple","scopes","promise","race","map","s","_race","Array","isArray","safeRace","defaultValue","promises","safe","terminatePromise","captureRawStack","set","then","delete","clone","Error","name","message","stack","join"],"sources":["../../src/utils/manualPromise.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { captureRawStack } from './stackTrace';\n\nexport class ManualPromise<T = void> extends Promise<T> {\n  private _resolve!: (t: T) => void;\n  private _reject!: (e: Error) => void;\n  private _isDone: boolean;\n\n  constructor() {\n    let resolve: (t: T) => void;\n    let reject: (e: Error) => void;\n    super((f, r) => {\n      resolve = f;\n      reject = r;\n    });\n    this._isDone = false;\n    this._resolve = resolve!;\n    this._reject = reject!;\n  }\n\n  isDone() {\n    return this._isDone;\n  }\n\n  resolve(t: T) {\n    this._isDone = true;\n    this._resolve(t);\n  }\n\n  reject(e: Error) {\n    this._isDone = true;\n    this._reject(e);\n  }\n\n  static override get [Symbol.species]() {\n    return Promise;\n  }\n\n  override get [Symbol.toStringTag]() {\n    return 'ManualPromise';\n  }\n}\n\nexport class LongStandingScope {\n  private _terminateError: Error | undefined;\n  private _closeError: Error | undefined;\n  private _terminatePromises = new Map<ManualPromise<Error>, string[]>();\n  private _isClosed = false;\n\n  reject(error: Error) {\n    this._isClosed = true;\n    this._terminateError = error;\n    for (const p of this._terminatePromises.keys())\n      p.resolve(error);\n  }\n\n  close(error: Error) {\n    this._isClosed = true;\n    this._closeError = error;\n    for (const [p, frames] of this._terminatePromises)\n      p.resolve(cloneError(error, frames));\n  }\n\n  isClosed() {\n    return this._isClosed;\n  }\n\n  static async raceMultiple<T>(scopes: LongStandingScope[], promise: Promise<T>): Promise<T> {\n    return Promise.race(scopes.map(s => s.race(promise)));\n  }\n\n  async race<T>(promise: Promise<T> | Promise<T>[]): Promise<T> {\n    return this._race(Array.isArray(promise) ? promise : [promise], false) as Promise<T>;\n  }\n\n  async safeRace<T>(promise: Promise<T>, defaultValue?: T): Promise<T> {\n    return this._race([promise], true, defaultValue);\n  }\n\n  private async _race(promises: Promise<any>[], safe: boolean, defaultValue?: any): Promise<any> {\n    const terminatePromise = new ManualPromise<Error>();\n    const frames = captureRawStack();\n    if (this._terminateError)\n      terminatePromise.resolve(this._terminateError);\n    if (this._closeError)\n      terminatePromise.resolve(cloneError(this._closeError, frames));\n    this._terminatePromises.set(terminatePromise, frames);\n    try {\n      return await Promise.race([\n        terminatePromise.then(e => safe ? defaultValue : Promise.reject(e)),\n        ...promises\n      ]);\n    } finally {\n      this._terminatePromises.delete(terminatePromise);\n    }\n  }\n}\n\nfunction cloneError(error: Error, frames: string[]) {\n  const clone = new Error();\n  clone.name = error.name;\n  clone.message = error.message;\n  clone.stack = [error.name + ':' + error.message, ...frames].join('\\n');\n  return clone;\n}\n"],"mappings":"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","ignoreList":[]}
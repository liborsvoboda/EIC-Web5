{"version":3,"file":"debugLogger.js","names":["_utilsBundle","require","_fs","_interopRequireDefault","e","__esModule","default","debugLoggerColorMap","DebugLogger","constructor","_debuggers","Map","process","env","DEBUG_FILE","ansiRegex","RegExp","join","stream","fs","createWriteStream","debug","log","data","write","replace","name","message","cachedDebugger","get","set","color","isEnabled","enabled","debugLogger","exports","kLogCount","RecentLogsCollector","_logs","push","length","splice","recentLogs","slice"],"sources":["../../src/utils/debugLogger.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { debug } from '../utilsBundle';\nimport fs from 'fs';\n\nconst debugLoggerColorMap = {\n  'api': 45, // cyan\n  'protocol': 34, // green\n  'install': 34, // green\n  'download': 34, // green\n  'browser': 0, // reset\n  'socks': 92, // purple\n  'error': 160, // red,\n  'channel': 33, // blue\n  'server': 45, // cyan\n  'server:channel': 34, // green\n  'server:metadata': 33, // blue\n};\nexport type LogName = keyof typeof debugLoggerColorMap;\n\nclass DebugLogger {\n  private _debuggers = new Map<string, debug.IDebugger>();\n\n  constructor() {\n    if (process.env.DEBUG_FILE) {\n      const ansiRegex = new RegExp([\n        '[\\\\u001B\\\\u009B][[\\\\]()#;?]*(?:(?:(?:[a-zA-Z\\\\d]*(?:;[-a-zA-Z\\\\d\\\\/#&.:=?%@~_]*)*)?\\\\u0007)',\n        '(?:(?:\\\\d{1,4}(?:;\\\\d{0,4})*)?[\\\\dA-PR-TZcf-ntqry=><~]))'\n      ].join('|'), 'g');\n      const stream = fs.createWriteStream(process.env.DEBUG_FILE);\n      (debug as any).log = (data: string) => {\n        stream.write(data.replace(ansiRegex, ''));\n        stream.write('\\n');\n      };\n    }\n  }\n\n  log(name: LogName, message: string | Error | object) {\n    let cachedDebugger = this._debuggers.get(name);\n    if (!cachedDebugger) {\n      cachedDebugger = debug(`pw:${name}`);\n      this._debuggers.set(name, cachedDebugger);\n      (cachedDebugger as any).color = debugLoggerColorMap[name] || 0;\n    }\n    cachedDebugger(message);\n  }\n\n  isEnabled(name: LogName) {\n    return debug.enabled(`pw:${name}`);\n  }\n}\n\nexport const debugLogger = new DebugLogger();\n\nconst kLogCount = 150;\nexport class RecentLogsCollector {\n  private _logs: string[] = [];\n\n  log(message: string) {\n    this._logs.push(message);\n    if (this._logs.length === kLogCount * 2)\n      this._logs.splice(0, kLogCount);\n  }\n\n  recentLogs(): string[] {\n    if (this._logs.length > kLogCount)\n      return this._logs.slice(-kLogCount);\n    return this._logs;\n  }\n}\n"],"mappings":"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","ignoreList":[]}
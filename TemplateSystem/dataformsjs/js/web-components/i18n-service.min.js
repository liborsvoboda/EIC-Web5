import{WebComponentService}from"./WebComponentService.min.js";import{showErrorAlert,setElementText}from"./utils.min.js";class I18nService extends WebComponentService{constructor(){function t(t,e,n=null){const i=t.getAttribute(e);return i||n}super(),this.fileName=t(this,"file","_"),this.fileDir=t(this,"file-dir","i18n"),this.defaultLocale=t(this,"default-locale"),this.supportedLocales=t(this,"locales","").split(",").map((t=>t.trim())),this.currentLocale=null,this.langText={},this.langCache={},this._isRunning=!1,window.i18nText=this.getText.bind(this);const e=document.querySelector("url-router");this.hashRouting=null===e||"history"!==e.getAttribute("mode")}getUserDefaultLang(){if(navigator.languages&&navigator.languages.length&&this.supportedLocales&&this.supportedLocales.length)for(let t=0,e=navigator.languages.length;t<e;t++)if(-1!==this.supportedLocales.indexOf(navigator.languages[t]))return navigator.languages[t];return this.defaultLocale}validateSettings(){return null===this.defaultLocale?(console.warn("Using <i18n-service> without [default-locale] being filled in."),!1):0!==this.supportedLocales.length||(console.warn("Using <i18n-service> without [locales] being filled in."),!1)}onLoad(){if(this._isRunning)return;this._isRunning=!0;const t=this.validateSettings(),e=document.querySelector("url-router");if(this.currentLocale=null,this.hashRouting?t&&0===window.location.hash.indexOf("#/")&&(this.currentLocale=window.location.hash.split("/")[1]):t&&window.location.pathname.split("/").length>1&&(this.currentLocale=window.location.pathname.split("/")[1]),null!==this.currentLocale&&(""!==this.currentLocale&&-1!==this.supportedLocales.indexOf(this.currentLocale)||(this.currentLocale=null)),window.i18n_Locale=this.currentLocale,null===this.currentLocale)return this._isRunning=!1,void(e&&e.querySelector('url-route[path="/:lang/"]')&&(this.hashRouting?window.location="#/"+this.defaultLocale+"/":e.changeRoute("/"+this.defaultLocale+"/")));document.documentElement.lang=this.currentLocale;const n=this.fileDir+"/"+this.fileName+"."+this.currentLocale+".json",i=[this.downloadFile(n)],l=e&&e.currentRoute?e.currentRoute.getAttribute("data-i18n-file"):null;let o=null;l&&(o=this.fileDir+"/"+l+"."+this.currentLocale+".json",i.push(this.downloadFile(o))),Promise.all(i).finally((()=>{this.langText=o?Object.assign({},this.langCache[n],this.langCache[o]):this.langCache[n],this.updateContent(document),this.dispatchEvent(new CustomEvent("app:i18nLoaded",{bubbles:!0})),this._isRunning=!1}))}getText(t){return this.langText&&this.langText[t]?this.langText[t]:t}downloadFile(t){return void 0!==this.langCache[t]?new Promise((t=>{t()})):fetch(t,{cache:"no-store",credentials:"same-origin"}).then((t=>{const e=t.status;if(e>=200&&e<300||304===e)return Promise.resolve(t);{const n=`Error loading data. Server Response Code: ${e}, Response Text: ${t.statusText}`;return Promise.reject(n)}})).then((t=>t.json())).then((e=>{this.langCache[t]=e})).catch((e=>{showErrorAlert(`Error Downloading I18N file: [${t}], Response Code Status: ${e.message}`),this.langCache[t]={}}))}updateContent(t){let e=t.querySelectorAll("[data-i18n]");for(const t of e){const e=t.getAttribute("data-i18n"),n=void 0===this.langText[e]?"":this.langText[e];setElementText(t,n)}e=t.querySelectorAll("[data-i18n-attr]");for(const t of e){const e=t.getAttribute("data-i18n-attr").split(",").map((function(t){return t.trim()}));for(let n=0,i=e.length;n<i;n++){const i=e[n];let l,o,s=t.getAttribute(i);if(null===s){console.warn(t,"Missing Attribute ["+i+"] for element");continue}if(l=this.langText[s],void 0!==l){t.setAttribute(i,l);continue}const a=/\[\[.*\]\]/g;for(;null!==(o=a.exec(s));){if(l=o[0].substring(2,o[0].length-2),void 0===this.langText[l])continue;let t=o[0].replace(/\[/g,"\\[");t=new RegExp(t,"g"),s=s.replace(t,this.langText[l])}t.setAttribute(i,s)}}e=t.querySelectorAll("a[data-i18n-href]");for(const t of e){const e=t.getAttribute("href").split("/"),n=t.getAttribute("href");(this.hashRouting?0===n.indexOf("#/"):0===n.indexOf("/"))&&e.length>1&&(e[1]=this.currentLocale,t.href=e.join("/"))}e=t.querySelectorAll("a[data-i18n-locales]");for(const t of e){const e=t.getAttribute("data-i18n-locales").split(",").map((t=>t.trim()));let n=this.currentLocale;-1===e.indexOf(n)&&(n=-1!==e.indexOf(this.defaultLocale)?this.defaultLocale:e[0]);const i=new RegExp("\\[locale]","g");t.href=t.href.replace(i,n)}e=t.querySelectorAll("[data-i18n-replace-text]");for(const t of e){let e=t.innerHTML;for(const t in this.langText)if(this.langText.hasOwnProperty(t)){let n="[[i18n "+t+"]]";if(-1!==e.indexOf(n)){n="\\[\\[i18n "+t+"]]";const i=new RegExp(n,"g"),l=this.langText[t]?this.langText[t]:t;e=e.replace(i,l)}}t.innerHTML=e}if(e=t.querySelectorAll("[data-i18n-nav-lang]"),e.length>0){const t=this.hashRouting?null:document.querySelector("url-router").handlePushStateClick;for(const n of e){const e=n.getAttribute("data-i18n-nav-lang");this.hashRouting?n.href=window.location.hash.replace("#/"+this.currentLocale+"/","#/"+e+"/"):(n.href=window.location.pathname.replace("/"+this.currentLocale+"/","/"+e+"/"),n.addEventListener("click",t))}}e=t.querySelectorAll("[data-i18n-nav-selected]");for(const t of e)t.textContent=this.currentLocale;e=t.querySelectorAll('nav[is="spa-links"]');for(const t of e)"function"==typeof t.updateLinks&&t.updateLinks()}}window.customElements.define("i18n-service",I18nService);
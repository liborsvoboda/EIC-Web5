import{WebComponentService}from"./WebComponentService.min.js";import{isDomAttached}from"./utils.min.js";const _operators=["excludes","excludes_list","!==","==="];let _runFilter=!0;function getFilter(e){let t,l,r,i,s,o=e.getAttribute("data-filter-selector"),n=e.getAttribute("data-filter-results-text-selector"),a={itemsSelector:o,items:null===o?null:document.querySelectorAll(o),columnFilter:e.getAttribute("data-filter-column"),resultsTextSelector:n,resultsTextElement:null===n?null:document.querySelector(n),textAll:e.getAttribute("data-filter-results-text-all"),textFiltered:e.getAttribute("data-filter-results-text-filtered"),filterHideOnEmpty:e.getAttribute("data-filter-results-text-hide-on-empty"),dataList:null===e.getAttribute("list")?e.getAttribute("data-list"):e.getAttribute("list"),cssOdd:e.getAttribute("data-filter-class-odd"),cssEven:e.getAttribute("data-filter-class-even"),colIndex:null,clickedFilter:e.getAttribute("data-filter-clicked"),operator:e.getAttribute("data-filter-operator"),filterValue:e.getAttribute("data-filter-value"),filterWords:[],containsInputs:o&&null!==document.querySelector(o+" input, "+o+" select, "+o+" textarea")};function u(t){throw console.log(t),console.log(e),console.log(a),t}if(null===a.items)return a;for(null!==a.operator&&(null===a.filterValue?u("Filter if attribute [data-filter-operator] is defined then the attribute [data-filter-value] must also be defined."):-1===_operators.indexOf(a.operator)&&u("Filter if attribute [data-filter-operator] is defined then it must equal one of the following operators: ['"+_operators.join("', '")+"'].")),"INPUT"===e.nodeName?t=e.value.toLowerCase().trim().split(" "):(null===a.filterValue&&u("Filter Element requires missing attribute [data-filter-value]."),null===a.clickedFilter?t=[]:"excludes_list"===a.operator?t=a.filterValue.toLowerCase().trim().split("|"):"!=="===a.operator||"==="===a.operator?(a.filterValue=a.filterValue.toLowerCase(),t=[a.filterValue]):t=a.filterValue.toLowerCase().trim().split(" ")),l=0,r=t.length;l<r;l++)""!==t[l]&&a.filterWords.push(t[l]);if(null!==a.columnFilter){if(1!==a.items.length||"TABLE"!==a.items[0].tagName||!a.items[0].tHead||1!==a.items[0].tHead.rows.length||1!==a.items[0].tBodies.length)return a;for(i=document.querySelector(a.itemsSelector),a.items=i.tBodies[0].rows,s=i.tHead.rows.length-1,l=0,r=i.tHead.rows[s].cells.length;l<r;l++)if(i.tHead.rows[s].cells[l].textContent.trim()===a.columnFilter){a.colIndex=l;break}null===a.colIndex&&u("Column ["+a.columnFilter+"] was not found in the table to filter.")}else if(1===a.items.length&&"TABLE"===a.items[0].tagName)switch(i=a.items[0],i.tBodies.length){case 0:a.items=[];break;case 1:a.items=i.tBodies[0].rows,null===a.cssOdd&&null===a.cssEven&&(a.cssOdd=i.getAttribute("data-sort-class-odd"),a.cssEven=i.getAttribute("data-sort-class-even"));break;default:console.warn("Unexpected Table format for Filter Plugin. Only 1 <tbody> element is supported.")}return a}class FilterService extends WebComponentService{onLoad(e){const t=document.querySelector("[data-filter-selector]");if(null===t)return;const l=document.querySelector("json-data");if(null===l)return void this.setup(e);let r=window.setInterval((()=>{!0!==l.isLoading&&(window.clearInterval(r),r=null,isDomAttached(t)&&this.setup(e))}),100)}setup(e){const t=e.nodeName;("URL-ROUTE"===t||t.includes("-SERVICE"))&&(e=document),this.setupDataLists(e),this.setupFilters(e)}setupDataLists(e){const t=this.getSettings(e);for(const e of t){if(null===e.items||null===e.dataList)return;let t=document.getElementById(e.dataList);if(null===t&&(t=document.querySelector(e.dataList)),null===t||"DATALIST"!==t.tagName)return;const l=[];Array.prototype.forEach.call(e.items,(function(t){let r="";null===e.colIndex?r=t.textContent:t.cells.length>=e.colIndex&&(r=t.cells[e.colIndex].textContent),""!==r&&-1===l.indexOf(r)&&l.push(r)})),l.sort(),t.innerHTML="",l.forEach((function(e){const l=document.createElement("option");l.textContent=e,t.appendChild(l)}))}}setupFilters(e){const t=this;let l=e.querySelectorAll("[data-filter-selector]:not([data-filter-setup])");for(const e of l)"INPUT"===e.nodeName?e.addEventListener("input",t.filter.bind(t)):(e.addEventListener("click",(function(){t.clearClickedFilters(this.getAttribute("data-filter-selector")),this.setAttribute("data-filter-clicked",""),t.filter()})),e.style.cursor="pointer"),e.setAttribute("data-filter-setup","setup");l=document.querySelectorAll("[data-filter-clear]:not([data-filter-setup])");for(const e of l)e.addEventListener("click",(function(){_runFilter=!1,t.clearFilter(this.getAttribute("data-filter-clear")),_runFilter=!0,t.filter()})),e.setAttribute("data-filter-setup","setup");l=document.querySelectorAll("[data-filter-clear-all]:not([data-filter-setup])");for(const e of l)e.addEventListener("click",(function(){_runFilter=!1,t.clearAllFilters(),_runFilter=!0,t.filter()})),e.setAttribute("data-filter-setup","setup");l=document.querySelectorAll("[data-set-filter-selector]:not([data-set-filter-setup])");for(const e of l)e.addEventListener("click",(function(){const e=this.getAttribute("data-set-filter-selector"),l=document.querySelector(e);null!==l?null!==l.getAttribute("data-filter-selector")?(l.value=this.textContent,t.filter()):console.warn("Query Selector from Attribute [data-set-filter-selector = "+e+"] did a valid filter element that has [data-filter-selector] defined."):console.warn("Query Selector from Attribute [data-set-filter-selector = "+e+"] did not return an element.")})),e.setAttribute("data-set-filter-setup","setup");this.filter()}clearAllFilters(){const e=document.querySelectorAll("input[data-filter-selector],[data-filter-selector][data-filter-clicked]");for(const t of e)"INPUT"===t.nodeName?t.value="":t.removeAttribute("data-filter-clicked")}clearFilter(e){const t=document.querySelectorAll("input[data-filter-selector],[data-filter-selector][data-filter-clicked]");for(const l of t)l.getAttribute("data-filter-selector")===e&&("INPUT"===l.nodeName?l.value="":l.removeAttribute("data-filter-clicked"))}clearClickedFilters(e){const t=document.querySelectorAll("[data-filter-selector][data-filter-clicked]");for(const l of t)l.getAttribute("data-filter-selector")===e&&l.removeAttribute("data-filter-clicked")}getSettings(e){const t=(e||document).querySelectorAll("[data-filter-selector]"),l=[];for(const e of t)l.push(getFilter(e));return l}filter(){let e,t,l,r,i,s,o,n,a,u=[],c=!1;function d(e,t){let l,r,i,s="",o=!1,n=null,a=null;if(null===e.colIndex?a=t:t.cells.length>=e.colIndex&&(a=t.cells[e.colIndex]),null!==a&&(s=a.getAttribute("data-filter-search-text"),null===s&&(s=a.textContent),s=s.toLowerCase(),n=e.containsInputs?a.querySelectorAll("input, select, textarea"):null),null!==n){for(s="",l=0,r=n.length;l<r;l++)"INPUT"!==n[l].nodeName||"checkbox"!==n[l].type&&"radio"!==n[l].type?s+=n[l].value.toLowerCase()+" ":s+=String(n[l].checked)+" ";if("TR"===t.nodeName)for(l=0,r=t.cells.length;l<r;l++)0===t.cells[l].querySelectorAll("input, select, textarea").length&&(s+=t.cells[l].textContent.toLowerCase()+" ")}switch(e.operator){case"===":if(s!==e.filterValue)return t.style.display="none",!0;break;case"!==":if(s===e.filterValue)return t.style.display="none",!0;break;case"excludes":for(i=!1,l=0,r=e.filterWords.length;l<r;l++)if(o=-1!==s.indexOf(e.filterWords[l]),o){i=!0;break}if(i)return t.style.display="none",!0;break;case"excludes_list":for(i=!1,l=0,r=e.filterWords.length;l<r;l++)if(o=s===e.filterWords[l],o){i=!0;break}if(i)return t.style.display="none",!0;break;default:for(l=0,r=e.filterWords.length;l<r;l++)if(-1===s.indexOf(e.filterWords[l]))return t.style.display="none",!0}return!1}if(_runFilter){if(e=this.getSettings(),t=document.querySelectorAll("[data-filter-clear]"),l=document.querySelectorAll("[data-filter-clear-all]"),1===e.length){if(null!==e[0].items)if(i=e[0].items,0===e[0].filterWords.length)for(r=0,s=i.length;r<s;r++)""!==i[r].style.display&&(i[r].style.display=""),i[r].removeAttribute("data-filter-item");else for(r=0,s=i.length;r<s;r++)a=d(e[0],i[r]),a||""===i[r].style.display||(i[r].style.display=""),i[r].setAttribute("data-filter-item",a?"hide":"show")}else{for(o=0,n=e.length;o<n;o++)if(i=e[o].items,null!==i)for(r=0,s=i.length;r<s;r++)""!==i[r].style.display&&(i[r].style.display=""),i[r].removeAttribute("data-filter-item");for(o=0,n=e.length;o<n;o++)if(i=e[o].items,null!==i&&e[o].filterWords.length>0)for(r=0,s=i.length;r<s;r++)a=d(e[o],i[r]),i[r].setAttribute("data-filter-item",a?"hide":"show")}e.forEach((function(e){let l=0,r="",i=!0,s=e.itemsSelector,o=e.cssEven&&e.cssOdd;if(-1===u.indexOf(s)){if(Array.prototype.forEach.call(e.items,(function(t){""===t.style.display?(l++,o&&(l%2==0?(t.classList.add(e.cssEven),t.classList.remove(e.cssOdd)):(t.classList.add(e.cssOdd),t.classList.remove(e.cssEven)))):(i=!1,c=!0)})),null!==e.resultsTextElement&&null!==e.textAll&&null!==e.textFiltered){r=e.items.length===l?e.textAll:e.textFiltered.replace(/{displayCount}/g,l),r=r.replace(/{totalCount}/g,e.items.length);const t=document.querySelector("url-router");t&&"object"==typeof t.currentUrlParams&&(r=r.replace(/{(.+)}/g,(function(e,l){return void 0!==t.currentUrlParams[l]?String(t.currentUrlParams[l]):e}))),e.resultsTextElement.textContent=r,null!==e.filterHideOnEmpty&&(e.resultsTextElement.style.display=""===r?"none":"")}Array.prototype.forEach.call(t,(function(e){e.getAttribute("data-filter-clear")===s&&(e.style.display=i?"none":"")})),u.push(s)}})),Array.prototype.forEach.call(l,(function(e){e.style.display=c?"":"none"}))}}}window.customElements.define("filter-service",FilterService);
import{WebComponentService}from"./WebComponentService.min.js";import{showErrorAlert}from"./utils.min.js";function isNumeric(e){return!isNaN(e)&&isFinite(e)&&!(e.length>1&&"0"===e.substring(0,1))}function excelValue(e){if(""===(e=e.trim()))return null;if(isNumeric(e))return parseFloat(e);{const t=new Date(e);if(!isNaN(t.getTime())&&t.getYear()>0&&(e.includes("-")||e.includes(",")||e.includes("/")))return t}return e}function downloadExcelJS(e){if(void 0!==window.ExcelJS)return void e();const t=document.createElement("script");t.src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js",t.onload=e,document.querySelector("head").appendChild(t)}function hasInvalidFileNameChars(e){const t=['"',"<",">","|",":","*","?","\\","/"];for(const n of t)if(e.includes(n))return!0;for(let t=0;t<32;t++)if(e.includes(String.fromCharCode(t)))return!0;return!1}function exportTable(e){const t="data-running-export";null===e.target.getAttribute(t)&&(e.target.setAttribute(t,""),"BUTTON"===e.target.nodeName&&(e.target.disabled=!0),downloadExcelJS((()=>{const n=e.target.getAttribute("data-export-excel-selector");let o=e.target.getAttribute("data-export-file-name");if(o&&(o.length<=5||!o.endsWith(".xlsx")||hasInvalidFileNameChars(o)))return void showErrorAlert("Attribute [data-export-file-name] must be a valid name with file type [*.xlsx]");o=o||"Report.xlsx";let r=e.target.getAttribute("data-worksheet-name");r=r||o.substring(0,o.length-5),r.length>31&&(r=r.substring(0,31));const l=null!==e.target.getAttribute("data-export-all"),i=document.querySelector(n),a=[],s=[];let c=[],d=i.tHead.rows[0];for(let e=0,t=d.cells.length;e<t;e++){const t=d.cells[e].textContent;c.push(t);const n=t.trim().length,o=parseInt(Math.max(1.2*n,n+4));s.push(o)}a.push(c);const u=i.tBodies[0].rows;for(let e=0,t=u.length;e<t;e++)if(d=u[e],l||"none"!==d.style.display){c=[];for(let e=0,t=d.cells.length;e<t;e++){const t=d.cells[e];let n=t.getAttribute("data-value");null===n&&(n=t.textContent);let o=n.trim().length;n=excelValue(n),n instanceof Date?o=12:"number"==typeof n?o=n.toString().length+2:o<=20&&(o+=2),s[e]=Math.max(s[e],o),c.push(n)}a.push(c)}const m=new ExcelJS.Workbook,g=m.addWorksheet(r);for(const e of a)g.addRow(e);const f=g.getRow(1);for(let e=0;e<s.length;e++){const t=f.getCell(e+1);t.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFF2F2F2"}},t.font={bold:!0}}for(let e=0;e<s.length;e++)g.getColumn(e+1).width=Math.min(50,s[e]);g.autoFilter={from:{row:1,column:1},to:{row:a.length,column:s.length}},g.views=[{state:"frozen",ySplit:1}],m.xlsx.writeBuffer().then((n=>{const r=new Blob([n],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});if(void 0!==navigator.msSaveBlob)navigator.msSaveBlob(r,o);else{const e=document.createElement("a"),t=URL.createObjectURL(r);e.setAttribute("href",t),e.setAttribute("download",o),e.style.visibility="hidden",document.body.appendChild(e),e.click(),document.body.removeChild(e)}e.target.removeAttribute(t),"BUTTON"===e.target.nodeName&&(e.target.disabled=!1)}))})))}window.customElements.define("export-to-excel-service",class extends WebComponentService{onLoad(){const e=document.querySelectorAll("[data-export-excel-selector]");let t=!1;if(e.length>0){let e=document.querySelector("a");null===e&&(e=document.createElement("a")),t=void 0!==navigator.msSaveBlob||void 0!==e.download}for(const n of e)t?n.addEventListener("click",exportTable):n.style.display="none"}});